<!DOCTYPE html>
<html lang="en" xmlns:th="www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <div th:replace="/fragments/header.html :: header"></div>
    <link rel="stylesheet" th:href="@{/css/room.css}">
    <title>ChattingRoom</title>
</head>
<body>

<div class="root">
    <div class="title d-flex">
        <div class="title-bar">
            <div style="width:12%; display:flex">
                <img th:src="@{/img/chat/00 흰 화살.png}" style="width:20px; height:20px">
            </div>
<!--            <div class="go-back" style="width:15%"></div>-->
            <span th:text="${user.nickname}" style="width:68%"></span>
            <div style="width:20%">
                <img src="C:\Users\문지혜\Documents\GitHub\granola\img\chat\02_채팅방.png" style="width:6%; position:relative; top:88px; left: 212px">
                <img src="C:\Users\문지혜\Documents\GitHub\granola\img\chat\03_채팅방.png" style="width:6%; position:relative; top:84px; left: 238px">
            </div>
        </div>
        </div>
    <div class="container px-4" style="margin-top:120px">
        <ul id="messageArea">
            <li th:each="m : ${messages}">
                <div class="chat-message">
                    <block th:if="${m.user.id} == ${user.id}">
                        <div class="text-align-end">
                            <span th:text="${m.message}"></span>
                        </div>
                    </block>
                    <block th:unless="${m.user.id} == ${user.id}">
                        <div class="">
                            <span th:text="${m.message}"></span>
                        </div>
                    </block>
                </div>
            </li>
        </ul>
        <div id="messageForm" name="messageForm">
            <div class="form-group">
                <div class="input-group">
                    <img src="C:\Users\문지혜\Documents\GitHub\granola\img\chat\08_채팅방.png" style="width:6%; position:relative; left:25px; top:6px">
                    <input type="text" id="message" placeholder="메세지를 입력하세요." autocomplete="off" class="form-control" 
                    style="border:0;; width:80%; background: #fff; border-radius: 20px; height:30px; padding-left:5px; box-sizing:border-box; margin-top:5px; position: relative; left:9%; bottom:3px">
                    <button id="formSubmit" type="submit" class="primary"><img src="C:\Users\문지혜\Documents\GitHub\granola\img\chat\09_채팅방.png" style="width:6%; position:relative; top:6px">보내기</button>
                </div>
            </div>
        </div>
    </div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    var messageForm = document.querySelector('#messageForm');
    var messageInput = document.querySelector('#message');
    var messageArea = document.querySelector('#messageArea');
    var connectingElement = document.querySelector('.connecting');

var stompClient = null;

var senderId = /*[[ ${user.id} ]]*/;
var roomId = /*[[ ${roomId} ]]*/;

var colors = [
    '#2196F3', '#32c787', '#00BCD4', '#ff5652',
    '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
];
const URLSearch = new URLSearchParams(location.search);;

    $(document).ready(function(){
        $('html, body').scrollTop(document.body.scrollHeight)
        connect();
    });

    function connect(event) {

        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, onConnected);
    }


    function onConnected() {
        stompClient.subscribe('/sub/chat/room/' + URLSearch.get("id"), onMessageReceived);

        stompClient.send("/pub/chat/message",
            {},
            JSON.stringify({
                senderId: senderId,
                type: 'JOIN',
                roomId: URLSearch.get("id")})
        )
    }
    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    }
    window.onbeforeunload = function(e){
        disconnect();
    }

function sendMessage() {
    var messageContent = messageInput.value.trim();
    if(messageContent && stompClient) {
        var chatMessage = {
            senderId: senderId,
            message: messageInput.value,
            type: 'CHAT',
            roomId: URLSearch.get("id")
        };
        stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
        messageInput.value = '';
    }
}


function onMessageReceived(payload) {
    var message = JSON.parse(payload.body);

    var messageElement = document.createElement('li');

    var divElement = document.createElement('div');
    divElement.classList.add('chat-message');

    var alignElement = document.createElement('div');
    if (message.user.id == senderId) {
        alignElement.classList.add('text-align-end');
    }

<!--        var avatarElement = document.createElement('i');-->
<!--        var avatarText = document.createTextNode(message.user.nickname[0]);-->
<!--        avatarElement.appendChild(avatarText);-->
<!--        avatarElement.style['background-color'] = getAvatarColor(message.user.nickname);-->

<!--        messageElement.appendChild(avatarElement);-->

<!--        var usernameElement = document.createElement('span');-->
<!--        var usernameText = document.createTextNode(message.user.nickname);-->
<!--        usernameElement.appendChild(usernameText);-->
<!--        messageElement.appendChild(usernameElement);-->


    var textElement = document.createElement('span');
    var messageText = document.createTextNode(message.message);
    textElement.appendChild(messageText);

    alignElement.appendChild(textElement);
    divElement.appendChild(alignElement);

    messageElement.appendChild(divElement);

    messageArea.appendChild(messageElement);
    messageArea.scrollTop = messageArea.scrollHeight;

    $.ajax({
            url:"/chat/receive",
            method:"post",
            data: JSON.stringify({roomId:roomId, userId:senderId}),
            contentType : "application/json; charset=utf-8",
        }).
        done(function(json) {
            <!--성공-->
        })
        .fail(function(xhr, status, error) {
            console.log(error);
            <!--서버상태 이상으로 데이터를 못가져오는 경우 알림            -->
        })
}

$("#formSubmit").on("click", function () {
    sendMessage();
})
/*]]*/
</script>
</html>